# 项目介绍

该项目是一个使用Spring Cloud构建的前后端分离的内容平台。功能类似于微信公众号，用户可以登录后浏览文章，也可以通过管理平台创作和发布文章。

## 项目技术栈与工具栈

- Spring Boot
- Spring Cloud
- MybatisPlus
- MySQL
- Redis 用于实现延迟队列
- Nacos 用作服务中心和配置中心
- Nginx 用于反向代理
- MinIO 用于图片、静态网页资源的存储

## 项目内容

该项目由5个微服务组成：

### 1. app服务网关

普通用户(用户群体1)通过web访问app时，会被Nginx代理到app网关。网关判断用户的token，判断token是否有效，有效的用户会被放行到用户微服务。

### 2. 自媒体服务网关

创作者(用户群体2)通过web访问自媒体服务时，会被Nginx代理到自媒体网关。同样根据用户token判断是否放行。

### 3. 用户微服务

负责用户的登录功能，有用户登录和游客登录两种(不需要用户名密码)，该微服务负责比对密码，登录成功后给前端返回jwt令牌。

### 4. 文章管理微服务

普通用户端(app端)是手机端，有文章信息展示，文章详情展示，文章发布等功能

普通用户登录后进入文章列表页面。文章微服务负责加载文章列表以及文章详情的展示。同时还为其他微服务提供保存文章的接口。

该微服务使用freemarker与MinIO。新文章发布时使用模版技术生成静态页面并上传到MinIO中，将得到的静态页面url存放到数据库中，用户访问文章详情时只需根据静态页面url获取内容即可。这种方式相比于每次根据文章id从数据库或缓存中获取内容并渲染加载，开销更小，效率更高。(数据库设计中文章信息与文章内容在两个表中，静态url在文章信息表中，会在调用时通过文章dto传给前端，所以无需重复查表，效率更高)

文章发布未其他微服务提供feign接口，自媒体端文章审核通过后会调用该接口发布文章。

### 5. 自媒体微服务

自媒体端是网页平台，有文章发布，文章审核，素材管理，频道管理等功能

创作者通过自媒体端登录，然后创作并提交文章，或存为草稿。提交的文章通过审核后会通过文章管理微服务进行发布，发布后即可被普通用户看到。同时自媒体微服务还有素材管理功能，可以管理图片素材，在文章创作时可直接使用已有素材。

#### 文章审核

文章在提交后会被自动审核。该模块可以集成付费审核服务，如腾讯云、阿里云的审核服务(目前未集成)。对文章的内容和图片进行审核，审核成功则发布。

#### 文章延迟发布

文章延迟发布使用任务调度微服务实现，在自媒体微服务中，当文章设置发布时间并提交后，调用任务调度微服务的添加任务接口，将任务添加到延迟队列中。然后文章审核模块会定时拉取任务，进行审核，然后调用文章微服务接口进行发布。



### 6. 任务调度微服务

为其他微服务提供延迟队列和任务调度功能。目前主要用于自媒体端文章延迟发布。

任务有立即执行和定时执行两种。该微服务提供三个feign接口: 添加任务、取消任务、拉取任务。

#### 6.1 添加任务

一个任务包含执行信息和执行时间等内容，先将任务存入数据库中

- 对于立即执行的任务(执行时间<=当前时间)，将任务加入Redis的list中
- 对于不久将来要执=执行的任务，加入Redis的zset中，根据执行时间排序
- 对于超过5分钟后执行的任务，无需添加进Redis

**6.1.1 未来任务定时刷新**

Redis中zset中的任务每分钟刷新一次，将需要执行的任务从zset中取出，加入到list中。该功能使用Redis scan方法实现，因为keys模糊匹配是单线程，会被阻塞，效率很低，而scan方法使用基于游标的迭代器分批进行，效率更高。将从zset中获取的数据加入list中时，使用PipeLine请求而不是直接调用，这样可以将多次请求连接合并为一次连接，效率有明显提升。

**6.1.2 数据库定时同步到Redis**

数据库中有5分钟后执行的任务未加载到Redis中，所以每5分钟对数据库中任务进行检查，对执行时间小于未来5分钟的，添加进Redis中。

#### 6.2 分布式锁解决集群下方法抢占执行

对于定时任务，当有多个服务运行时，可能发生方法抢占执行导致出错。所以使用Redis的setnx指令实现分布式锁。客户端在请求数据时会加上一个定时解开的锁，在上锁时其他客户端无法执行相同定时方法。

#### 6.3 取消任务

如果任务请求超时，有时需要取消任务，将任务从Redis中删除，并修改数据库即可

#### 6.4 拉取任务

该模块为其他微服务提供拉取任务的接口，根据参数，从Redis的list中RightPop出任务即可。